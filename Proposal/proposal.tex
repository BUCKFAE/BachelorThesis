\documentclass{article}
% General document formatting
\usepackage[margin=0.7in]{geometry}
\usepackage[parfill]{parskip}
\usepackage[utf8]{inputenc}
\usepackage{hyperref} 
\usepackage{booktabs}
\usepackage{graphicx}
\usepackage{subfig}
\usepackage{caption}
\usepackage{fancyhdr}

% Related to math
\usepackage{amsmath,amssymb,amsfonts,amsthm}
\title{Proposal - Playing pokemon battles optimally}
\author{Julian Schubert}

% Kopf- / Fu√üzeile
\makeatletter
\let\runauthor\@author
\let\runtitle\@title
\pagestyle{fancy}
\fancyhf{}
\rhead{\runtitle}
\lhead{\runauthor}
\cfoot{\thepage}

\begin{document}
\maketitle

\section{Introduction}
Pokemon is a video game series created by the Pokemon Company.
The goal of the game is to not only catch pokemon, but also to train them and use
them to battle other trainers. In the mainline games, the focus lies on the story
as well as exploring the world. The pokemon genere has evolved quite a bit since
it's early days, Figures \ref{fig:red0} and \ref{fig:red1} contain screenshots 
of the first pokemon games, pokemon red and pokemon green.
\begin{figure}[ht]
    \centering
    \begin{minipage}{.5\textwidth}
      \centering
      \includegraphics[width=.9\linewidth]{images/Red-0.jpg}
      \captionof{figure}{Exoploring the map in pokemon red}
      \label{fig:red0}
    \end{minipage}%
    \begin{minipage}{.5\textwidth}
      \centering
      \includegraphics[width=.9\linewidth]{images/Red-1.jpg}
      \captionof{figure}{Fighting another trainer in pokemon red}
      \label{fig:red1}
    \end{minipage}
    \caption*{Image source: \href{https://www.nintendo.de/Spiele/Game-Boy/Pokemon-Rote-Edition-266109.html}{nintendo.de}}
\end{figure}
Figures \ref{fig:sword0} and \ref{fig:sword1} contain ingame footage of the latest games in
the series, pokemon sword and shield.
\begin{figure}
  \centering
  \begin{minipage}{.48\textwidth}
    \centering
    \includegraphics[width=.9\linewidth]{images/Sword-0.jpg}
    \captionof{figure}{Exoploring the map in pokemon sword. \\ 
      Image source: \href{https://swordshield.pokemon.com/de-de/gameplay/pokemon-battle-stadium/}{pokemon.com}}
    \label{fig:sword0}
  \end{minipage}%
  \begin{minipage}{.48\textwidth}
    \centering
    \includegraphics[width=.9\linewidth]{images/Sword-1.jpg}
    \captionof{figure}{Fighting another trainer in pokemon sword \\
      Image source: Image source: \href{https://www.nintendo.de/Spiele/Nintendo-Switch/Pokemon-Schwert-1522111.html}{nintendo.de}}
    \label{fig:sword1}
  \end{minipage}
\end{figure}
This thesis will exclusivly focus exclusivly on battling as there detailed lists
of the locations of everything there is to explore within the games.

\section{Prerequisites}
Nintendo does not provide an API for the game, however, the fan project
\href{https://play.pokemonshowdown.com/}{Pokemon Showdown} is a
free online tool that can be used to battle online trainers. On top of that,
it provides the functionality to use their simulator offline in an CLI. The
entire source code for pokemon showdown can be found at 
\href{https://github.com/smogon/pokemon-showdown}{Github}.
Additionally, the python library \href{https://poke-env.readthedocs.io/en/latest/}{poke-env}
is used as it provides a convenient interface to showdown. \\
The combination of both tools allows to easily perform deep reinforcement learning
on a local running instance of showdown, as well as evaluating models against 
human players on the official pokemon showdown server. Figure \ref{fig:showdown-battle}
shows a battle between two human players on pokemon showdown. Lastly, the creators
of pokemon showdown provided me with over 8 Million replays of games played
by humans.

\section{Battling}
The focus of this thesis will be on batteling. Each player has a team of six 
pokemon. The pokemon are chosen randomly from the available
pokemon in the game. Currently, there are 898 different Pokemon, some of them 
even have different forms. Each pokemon knows 4 different, also randomly assigned,
moves. However, not every Pokemon can learn every move. \\
A move can either damage the opposing pokemon, heal the own pokemon, increase offence
or defence, or add status effects like paralysis or sleep. \\
The game works based on a rock-paper-scissors-like system. Each pokemon has one
or two types, each move has a type as well. Fire-Type moves are strong against
Grass types, Grass types are strong agains Water pokemon and water pokemon
are strong against fire pokemon. In total, there are 18 different types. \\
There are other aspects like weather, speed, base stats and level which
heavily influence the outcome of a battle, they won't be discussed in 
this proposal, however they will have to be taken into account in the thesis.

\begin{figure}
  \centering
  \includegraphics[width=.9\linewidth]{images/Showdown.png}
  \captionof{figure}{Screenshot of me batteling a random opponent}
  \label{fig:showdown-battle}
\end{figure}

\subsection{Advanced battling strategies}
In section \ref{sec:rulebased} a simpe rulebased approach is introduced that 
always picks the move that deals the most amount of damage. However, picking 
an optimal move is a lot more complex than this. Pokemon battles are not just
strict one on one battles where the player with the most damage dealing pokemon
always wins. In competetive play, a wide variety of non- or low-damaing moves
is used. Dragon Dance does not deal any damage to the opponent, but increases
the damage the pokemon deals in the next moves. \\
Additionally, each pokemon can play one or more different roles where the 
playstyles, again, counter each other in a rock paper scissors like fashion. 
Identifying in a random team what playstyle to pick for which pokemon is
essential to winning battles. This decision is also based on the playstyles
the opponent chooses. \\
Lastly, predicting enemy decisions is a key component of competive play. For 
example, if the pokemon of player 1 is strong against the pokemon of player 2,
the opposing player will likely switch to another pokemon. As an anticipation
of this move, the first player could pick a move that will deal less damage
against the current opposing pokemon but is also good against the pokemon
he assumes the enemy to switch to. \\
These elements turn competetive Pokemon in a game where traditional stratagy
and probability management are combined with information management.

\section{Execution}
This thesis will investigate multiple possible approaches to optimize battling.
The first approach will be a rule based. Different complexity levels will be
tested against each other. \\
Secondly, backpropagation will be used to train a neural network to play
like a human player. The traning data was provided to me by the pokemon
showdown team, it contains over 8 million replays of random pokemon battles. \\
Lastly, a reinforcement algorithm will be tested. The possibility to pretrain
the network using either rules or replay data will be investigated as well.

\section{Evaluation}
The poke-env libary provides not only a random player, but also a max damage player
that always chooses the move with the highest base damage. A simple reinforcement
approach is given as well. These three agents will be used as baseline. \\
Pokemon Showdown also has an Elo-System similar to chess. The authors of 
Showdown allow bots to compete in ranked matches, so the approaches
developed in this thesis will also be evaluated by playing ranked games 
against actual humans.

\section{Example rulebased approach}
\label{sec:rulebased}
During testing of the techincal feasibility of this approach, I developed a 
simple rule based approach.

\subsection{Damage Calculation}
The expected damage a move will deal to an opposing pokemon is calculated as follows:
\begin{equation*}
    \text{Expected Damage} = \text{Move Base Damage} \times \text{Move Type Modifier} 
        \times \text{Stab Modifier}
        \times \text{Move Accuracy}
\end{equation*}
\textbf{Stab Modifier}: If the type of the move is equal to one of the possibly two types
of the pokemon, the move will deal 1.5 times more damage. 

\subsection{Rules for playing}
Deciding on the next move is purely based on the expected damage in the current turn.
If a pokemon faints, the next pokemon to switch in is picked on based on the expected
damage it can deal to the opposing pokemon.

\subsection{Evaluation}
This approach was evaluated against a random player and a player that always chooses
the move with the hightest base damage. In 500 games, this approach won 484 out of 500
games against the random player and 419 / 500 games against the player that always chooses
the move with the highest base damage.

\section{Time Management}
Following table shows the general timeline for this thesis. 
\begin{table}[ht]
    \centering
    \begin{tabular}{|l|c|c|c|c|c|c|c|c|c|c|}
    \hline
     & \multicolumn{9}{c}{Time in weeks}  & \\ \hline
     & \textbf{1} & \textbf{2} & \textbf{3} & \textbf{4} & \textbf{5} & \textbf{6} & \textbf{7} & \textbf{8} & \textbf{9} & \textbf{10} \\ \hline
    Mechanics of the game                       & x &   &   &   &   &   &   &   &   &   \\ \hline
    Extracting Data from replays                &   & x &   &   &   &   &   &   &   &   \\ \hline
    Rulebased approach: Implementation          &   &   & x & x &   &   &   &   &   &   \\ \hline
    Buffer                                      &   &   &   &   & x &   &   &   &   &   \\ \hline
    Reinforcement learning: Research            &   &   &   &   &   & x &   &   &   &   \\ \hline
    Reinforcement learning: Implementation      &   &   &   &   &   &   & x & x &   &   \\ \hline
    Writing                                     & x & x & x & x & x & x & x & x & x & x \\ \hline
    \end{tabular}
    \caption{Time Management in weeks}
\end{table}
\end{document}